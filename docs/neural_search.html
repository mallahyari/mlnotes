---

title: Neural Search Engine with Transformers


keywords: fastai
sidebar: home_sidebar

summary: "This tutorial demonstrates how to create a search engine with transformers."
description: "This tutorial demonstrates how to create a search engine with transformers."
nb_path: "00_neural_search.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 00_neural_search.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The diagram below shows the architecture of the system:
<!-- <img src="images/semantic_search_diagram.png" width="600" height="500" /> --></p>
<p>{% include image.html width="600" height="500" max-width="600" file="/mlnotes/images/semantic_search_diagram.png" %}</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="FaissNeuralSearch" class="doc_header"><code>class</code> <code>FaissNeuralSearch</code><a href="https://github.com/mallahyari/mlnotes/tree/master/mlnotes/neural_search.py#L14" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>FaissNeuralSearch</code>(<strong><code>model</code></strong>, <strong><code>corpus</code></strong>)</p>
</blockquote>
<p>This class represents a neural search that uses faiss as the index for search.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Step-0:-Collect-a-dataset">Step 0: Collect a dataset<a class="anchor-link" href="#Step-0:-Collect-a-dataset"> </a></h2><p>I used a dataset that is about startups. Dataset is in json format and each record includes the name, a paragraph describing the company, the location and a picture. The dataset is available at <a href="https://storage.googleapis.com/generall-shared-data/startups_demo.json">this link</a>.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="s2">&quot;https://storage.googleapis.com/generall-shared-data/startups_demo.json&quot;</span><span class="p">,</span> <span class="n">lines</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>name</th>
      <th>images</th>
      <th>alt</th>
      <th>description</th>
      <th>link</th>
      <th>city</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>SaferCodes</td>
      <td>https://safer.codes/img/brand/logo-icon.png</td>
      <td>SaferCodes Logo QR codes generator system form...</td>
      <td>QR codes systems for COVID-19.\nSimple tools f...</td>
      <td>https://safer.codes</td>
      <td>Chicago</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Human Practice</td>
      <td>https://d1qb2nb5cznatu.cloudfront.net/startups...</td>
      <td>Human Practice -  health care information tech...</td>
      <td>Point-of-care word of mouth\nPreferral is a mo...</td>
      <td>http://humanpractice.com</td>
      <td>Chicago</td>
    </tr>
    <tr>
      <th>2</th>
      <td>StyleSeek</td>
      <td>https://d1qb2nb5cznatu.cloudfront.net/startups...</td>
      <td>StyleSeek -  e-commerce fashion mass customiza...</td>
      <td>Personalized e-commerce for lifestyle products...</td>
      <td>http://styleseek.com</td>
      <td>Chicago</td>
    </tr>
  </tbody>
</table>
</div></div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We only implement a search mechanism on the <code>description</code> column, i.e. we search and find similar companies based on the similarity of the <em>search query</em> and <em>descriptions</em>.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">corpus</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total number of documents: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">corpus</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Total number of documents: 40474
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>{% include note.html content='Depending on the quality of the documents, we may need to perform some preprocessing such as removing special characters, digits, etc.' %}</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Step-1:-Create-dense-vectors-of-documents-(i.e.-document-embeddings).">Step 1: Create dense vectors of documents (i.e. document embeddings).<a class="anchor-link" href="#Step-1:-Create-dense-vectors-of-documents-(i.e.-document-embeddings)."> </a></h2><p>We need to have an embedding model to create embeddings of our text documents. We use a pretrained language model from the <a href="https://www.sbert.net/docs/pretrained_models.html">Sentence Transformers</a>, specifically we utilize <code>all-distilroberta-v1</code> model as it works very well for semantic search applications.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Instantiate the model. You can set the device to `cpu` if don&#39;t have access to `gpu`.</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">SentenceTransformer</span><span class="p">(</span><span class="s1">&#39;sentence-transformers/all-distilroberta-v1&#39;</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span>

<span class="c1"># convert documents into embeddings</span>
<span class="n">corpus_embeddings</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">corpus</span><span class="p">,</span> <span class="n">show_progress_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Step-2:-Store-the-embeddings-or-index-the-embeddings">Step 2: Store the embeddings or index the embeddings<a class="anchor-link" href="#Step-2:-Store-the-embeddings-or-index-the-embeddings"> </a></h2><p>In order to be able to perform search and find documents, we need to store document embeddings in a document store. In other words, we have to <code>index</code> them. There are several different ways to do that, nevertheless, I work with Faiss for now.
Faiss allows us to search through billions of vectors very efficiently. For complete information about Faiss, please check their <a href="https://github.com/facebookresearch/faiss/wiki">wiki</a> page or read their <a href="https://arxiv.org/abs/1702.08734">paper</a>.</p>
<p>Faiss is built around the <code>Index</code> object, which contains searchable vectors. Faiss handles collections of vectors of a fixed dimensionality <code>d</code>, typically a few 10s to 100s.</p>
<blockquote><p><em>Faiss uses only 32-bit floating point matrices. This means we will have to change the data type of the input before building the index.</em></p>
</blockquote>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Convert the data type of the embeddings into float32.</span>
<span class="n">corpus_embeddings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">embedding</span> <span class="k">for</span> <span class="n">embedding</span> <span class="ow">in</span> <span class="n">corpus_embeddings</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>
<span class="n">corpus_embeddings</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(40474, 768)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Build the index. Shape of embeddings is (40474, 768), so we set the dimension of index to 768.</span>
<span class="n">index</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">IndexFlatL2</span><span class="p">(</span><span class="n">corpus_embeddings</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="c1"># Add the document vectors into the index</span>
<span class="n">index</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">corpus_embeddings</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Embed-the-search-query">Embed the search query<a class="anchor-link" href="#Embed-the-search-query"> </a></h2><p>Before we search for a query, we must convert the search query into an embedding using the same model we used for document embeddings.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">search_query</span> <span class="o">=</span> <span class="s2">&quot;smart devices&quot;</span>

<span class="c1"># Embed the query</span>
<span class="n">query_embedding</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">encode</span><span class="p">([</span><span class="n">search_query</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Step-4:-Perform-the-search">Step 4: Perform the search<a class="anchor-link" href="#Step-4:-Perform-the-search"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># We&#39;re interested in top-5 most similar documents</span>
<span class="n">top_k</span> <span class="o">=</span> <span class="mi">5</span>

<span class="c1"># Search function returns two arrays, Distances of the nearest neighbors with shape (n, k), and Labels/ids of the nearest neighbors with shape (n, k).</span>
<span class="n">distances</span><span class="p">,</span> <span class="n">ids</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">query_embedding</span><span class="p">),</span> <span class="n">k</span><span class="o">=</span><span class="n">top_k</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">distances</span><span class="p">,</span> <span class="n">ids</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>[[0.8278387 0.8530587 0.9144668 0.9390534 0.9465257]] [[36977  6544  2374 33638 40249]]
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Step-5:-Display-the-search-results">Step 5: Display the search results<a class="anchor-link" href="#Step-5:-Display-the-search-results"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;----------------------------------- Similar document </span><span class="si">{</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s2"> -------------------------------------------&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">corpus</span><span class="p">[</span><span class="n">ids</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]])</span>
    <span class="nb">print</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>----------------------------------- Similar document 1 -------------------------------------------
smartphone hardware possibilities
iPhone apps

----------------------------------- Similar document 2 -------------------------------------------
Smart sports products

----------------------------------- Similar document 3 -------------------------------------------
Inventing and manufacturing wearable and smart home products
Wearable products that utilize sensor technology and smart home devices.

----------------------------------- Similar document 4 -------------------------------------------
Smart sports equipment
Responsive Sports makes smart sports equipment, for example:
IPunch combat gloves that track punch impact, speed and type. The gloves send data over Bluetooth to a smart phone or tablet and upload stats to the web, allowing users to track their progress, take ...

----------------------------------- Similar document 5 -------------------------------------------
Internet of Things for Research
Developing a range of connected devices to make data collection for research easier.

</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Next-Steps">Next Steps<a class="anchor-link" href="#Next-Steps"> </a></h2><p>So far, we have implemented a search engine using Faiss fairly simply. However, There are several directions for improvement.</p>
<ul>
<li>Firstly, <code>IndexFlatL2</code> index that we used could be slow for very large datasets as it scales linearly with the number of indexed vectors. That said, Faiss provides <a href="https://github.com/facebookresearch/faiss/wiki/Faster-search">fast indexes</a>.</li>
<li>We can enhance the quality of the embeddings by using a domain specific pretrained model, which could result in better and more accuarate search results.</li>
<li>Is it possible to dynamically exclude vectors based on some criterion? What I mean is, what if we would like to search our documents based on some filters, for instance, only search among the companies that are in a specific city. In these cases, there is no easy solution if we want to make use of Faiss index. Therefore, what is the solution? The answer is to apply other approaches. These approaches are, to name a few:<ul>
<li><a href="https://haystack.deepset.ai/overview/intro">Haystack</a>: An open-source framework for building search systems that work intelligently over large document collections.</li>
<li><a href="https://github.com/qdrant/qdrant">Qdrant</a>: A Vector Search Engine for the next generation of AI applications.</li>
<li><a href="https://github.com/semi-technologies/weaviate">Weaviate</a>: Weaviate is a cloud-native, modular, real-time vector search engine</li>
</ul>
</li>
</ul>
<p>I will create several other examples using these packages and compare them.</p>

</div>
</div>
</div>
</div>


